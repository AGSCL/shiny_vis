---
title: "Visualización Dinámica en R con Shiny"
date: last-modified
date-format: "D [d]e MMM, YYYY"
author: "Andrés González-Santa Cruz"
subtitle: "CFG 2025: Ciencia abierta y ciudadana" #CUIDADO CON TILDES
institute: "Estudiante Doctorado en Salud Pública, Investigador joven, nDP"
format: 
  revealjs:
    theme: "_lib/theme2.scss"
    transition: slide
    title-slide-attributes:
      data-background-image: "_style/CCA-fondo.png"
      data-background-size: contain # <- muestra la imagen completa
      data-background-position: center
      data-background-color: "#F7F7F7"       # <- relleno para franjas
      data-background-repeat: no-repeat    
    css: 
      - _lib/animate.min.css
      - _lib/custom.css #con cuestiones de titulo
      - _lib/logo.css
      - _lib/graphics.css
    width: 1600
    height: 900      
    fig-cap-location: top
    lightbox: auto
    lang: es
    code-line-numbers: true   # habilita numeración global
    slide-number: true
    incremental: true
    self-contained: true # Embeds all assets locally
    navigation-mode: linear # Disable scroll-based navigation 
    logo: "_style/CCA-franjalogos_transparent.png"
    ratio: 16:9 # Slide aspect ratio
    include-after-body: 
      - _lib/zoom.html
      - _lib/timer-hud.js
    pdf-export: true # Enable PDF export
    code-fold: true
    code-summary: "expandir para código"
editor: source
engine: knitr
---

## Indice

```{r pre-setup}
#| include: false
#| code-fold: true
#| fig-align: "center"
#| warnings: false
#| message: false
#| results: hide

rm(list=ls());gc()

if(!require(shiny)){install.packages("shiny")}
if(!require(here)){install.packages("here")}
if(!require(showtext)){install.packages("showtext")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(ggiraph)){install.packages("ggiraph")}
if(!require(ggpattern)){install.packages("ggpattern")}
if(!require(RefManageR)){install.packages("RefManageR")}
if(!require(pagedown)){install.packages("pagedown")}
if(!require(magick)){install.packages("magick")}
if(!require(bibtex)){install.packages("bibtex")}
if(!require(DiagrammeR)){install.packages("DiagrammeR")}
if(!require(fontawesome)){install.packages("fontawesome")}
if(!require(widgetframe)){install.packages("widgetframe")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(psych)){install.packages("psych")}
if(!require(sf)){install.packages("sf")}
if(!require(geodata)){install.packages("geodata")}
if(!require(data.tree)){install.packages("data.tree")}
if(!require(googlesheets4)){install.packages("googlesheets4")}
if(!require(countdown)){install.packages("countdown")}
if(!require(crosstalk)){install.packages("crosstalk")}
if(!require(RColorBrewer)){install.packages("RColorBrewer")}
if(!require(plotly)){install.packages("plotly")}
if(!require(leaflet)){install.packages("leaflet")}
if(!require(dygraphs)){install.packages("dygraphs")}
if(!require(highcharter)){install.packages("highcharter")}
if(!require(d3po)){install.packages("d3po")}

# Activar showtext
showtext_auto()

font_add(
  family = "storia-sans",  # Este es el nombre que usarás en tu CSS
  regular = here::here("_style", "storia-sans", "StoriaSans-Light.ttf"),
  bold = here::here("_style", "storia-sans", "StoriaSans-Bold.ttf"),
  italic = here::here("_style", "storia-sans", "StoriaSans-Italic.ttf") # Descomenta si tienes itálicas
)
```

- Intro
  - Caso de uso
- Shiny
  - micro-teoría
  - componentes
- Manos a la obra: demo
- Pero centrémonos en los **gráficos y la visualización**:
  - plotly, highcharter (render dinámico)
  - Cuándo usar cada una.


<style>
@font-face {
  font-family: 'storia-sans'; /* El nombre que usas en grViz */
  src: url('_style/storia-sans/StoriaSans-Regular.ttf') format('truetype');
}
</style>

::: {.notes}
`r invisible("#_#_#_#_#_#NOTAS#_#_#_#_#_#_#")`

- **Shiny** es un paquete de R que permite construir aplicaciones web interactivas.
- Ideal para la visualización de datos y análisis interactivos.
- No requiere conocimientos avanzados de HTML o JavaScript.
- Permite transformar análisis en herramientas interactivas.
- Fácil integración en presentaciones con Quarto.
- Ideal para comunicar hallazgos de manera dinámica.

- Para mí, esta no es tanto una herramienta de reproducibilidad, como de comunicación de resultados y al servicio de la ciencia abierta

* Motivación (2 min): 2 pantallazos de ejemplo (mapa, serie) y la pregunta “¿qué cambiarías?”.
* Micro-teoría (4 min): anatomía Shiny en 1 slide + ciclo de reactividad (input→reactivo→render).
* Demo única (7–8 min): app con plotly (y mencionar cómo se cambia a leaflet/dygraphs).
* Checklist de elección (1 slide, 1 min):
*   Series → dygraphs
*   Mapas → leaflet
* Exploración general → plotly
* Dashboard “pulido” → highcharter (o plotly + theme)
* Cierre (1–2 min): enlace a repo/plantilla y 3 ideas de mini-proyecto.

<!----
#Press the S key (or use the Navigation Menu) to show the presentation speaker view:
---->

:::

## Caso de uso

- **Problemas**: 
  - Mucha información, poco espacio.
  - Hacer convivir el detalle con la impresión de conjunto.
  
- **Solución**:
  - Interacción: ¿preguntas?, respuestas inmediatas
  - Explorar datos, mejora comprensión, promueve ciencia abierta y colaboración

::: {.notes}
`r invisible("#_#_#_#_#_#NOTAS#_#_#_#_#_#_#")`

Problemas: Gráficos estáticos limitan la exploración de datos. Necesito hacerme una idea, pero navegar en todo se hace difícil. Recuerdo haber estado viendo un gráfico de 200 semanas, pero no podía ver detalles de cada semana. Había cosas que me llamaban la atención: semanas sin consultas, sin hospitalizaciones. Para eso, necesito interactividad para análisis más profundos, pero salir para ver lo holístico. Facilitar la comunicación de resultados complejos.

Solución: Uso de Shiny para crear aplicaciones web interactivas. Integración de gráficos dinámicos con plotly, highcharter, entre otros. Permitir a los usuarios explorar datos de manera intuitiva.Beneficios?: Mejora la comprensión de los datos, Facilita la toma de decisiones basada en datos, y Promueve la ciencia abierta y la colaboración.  

::: 

## Shiny: micro-teoría

:::: {.columns}

::: {.column width="50%"}
`ui` + 
`server` + 
reactividad → 
`render*()` → 
`*Output()`

:::

::: {.column width="50%"}
:::{.xsmall}
```r
# pseudo-esqueleto

ui <- fluidPage(
  sliderInput("n", "N:", 10, 100, 50), #input: control deslizante, llamado "n"
  plotOutput("p") #para visualizar el gráfico
)

server <- \(input, output, session){
  datos <- reactive({ rnorm(input$n) }) # función reactiva, depende de input$n para definir número de obs.
  output$p <- renderPlot({ hist(datos(), main= "Histograma", xlab="Datos", ylab="Frecuencia") }) # genera el gráfico "p"
}

shinyApp(ui, server)
```
:::
:::

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "expandir para código"
#| fig-align: "center"
#| warnings: false
#| message: false
#| fig.showtext: true
#| fig.cap: "Esquema: Estructura y reactividad"

DiagrammeR::grViz("
digraph shiny_diagram {
  rankdir=TB; // Dirección de arriba hacia abajo
  
  // Fondo general
  bgcolor='#F7F7F7';

  // Estilo de nodos
  graph [fontname='storia-sans'];
  node [shape=box, style=filled, fontname='storia-sans', fontsize=14, color=gray90];
  edge  [fontname='storia-sans', fontcolor=black, fontsize=12];
  
  // Cluster UI
  subgraph cluster_UI {
    label = 'UI (Frontend)';
    color = '#B03A2E'; // Color del borde del cluster
    style = rounded;
    fillcolor = '#F1948A'; // Fondo claro
    
    UI_input [label = 'Input', fillcolor='#9682fc50', color='#9682fc'];
    UI_output [label = 'Output', fillcolor='#01c9ad50', color='#01c9ad'];
  }

  // Nodo del servidor
  SERVER [label = 'Server (Backend)', shape=ellipse, fillcolor='#F1948A', color='#619CFF', style=solid];

  // Conexiones con etiquetas
  UI_input -> SERVER [label = 'Datos del\nusuario', fontname='storia-sans', fontcolor=black, fontsize=12];
  SERVER -> UI_output [label = 'Resultados', fontname='storia-sans', fontcolor=black, fontsize=12];

  // Alineación lógica
  {rank=same; UI_input; UI_output;}
}
")
```

::::

::: {.notes}`r invisible("#_#_#_#_#_#_#_#_##_#_#_#_#_#_#_#_#")`

- **UI**: interfaz de usuario, los elementos visuales con los que interactúa el usuario (botones, menús, gráficos). El front-end, la parte bonita, los botones, etc. Lo componen aspectos como `fluidPage()` para dar un diseño que se adapta a la pantalla, `titlePanel()` (título aplicación), o un panel lateral `sidebarLayout()` que le podemos añadir, vs. el principal `mainPanel()`.

- **SERVER**: Contiene la lógica del servidor, procesa las entradas del usuario y genera las salidas dinámicas. La lógica detrás (back-end), lo que trabaja para generar los gráficos. Requiere un `input$` que es el botoncito, etc., que está en UI y apretó el usuario, más los códigos internos; más un `output` que es la salida que mostrará com resultado dinámico. Regularmente los `output` son procesados por los `render`, en este caso, `renderPlot`.

- **SESSION**: Objeto que maneja la sesión del usuario, permitiendo personalizar la experiencia según el usuario.

- **Reactividad**: Mecanismo que permite que los cambios en la UI se reflejen automáticamente en las salidas sin necesidad de recargar la página.

- **Render**: Funciones que generan las salidas dinámicas (gráficos, tablas) basadas en las entradas del usuario.

- **Output**: Elementos que muestran los resultados generados por las funciones de render.

- Lo que hace ShinyApp es que los conecta generando una aplicación funcional.

:::


## Algunos ejemplos

::: {.center}

[Acceda aquí](https://agscl3.shinyapps.io/shiny_vis/)

:::

::: {.notes}
`r invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#")`
- Ahora vamos a ir a mi aplicación que les preparé
:::

## Hacer una imágen dinámica (1)

::: {.fragment}
:::{.xxsmall}
```{r}
#| code-line-numbers: "1-3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19"
#| echo: true
#| code-fold: false
#| fig-align: "center"
#| warnings: false
#| message: false
#| fig.showtext: true
#| fig-background: "transparent"

df <- tibble::tibble( #generamos una base de datos
  categoria = c("Antidepresivos", "Marihuana", "Ansiolíticos", "Alcohol", 
                "Hipnóticos", "Cocaína"), n = c(120, 90, 70, 25, 18, 10))
plotly::plot_ly( #generamos la primera entrada del gráfico interactivo
  df, #defino la base de datos
  labels = ~categoria, #donde se encuentra la etiqueta de las categorías y a qué columna refiere en la base de datos. Nótese la virgulilla
  values = ~n, #donde se encuentra el valor numérico y a qué columna refiere en la base de datos
  type   = "pie", #tipo de gráfico. EN este caso, de torta
  textinfo = "label+percent", #qué información mostrar en el gráfico
  hovertemplate = "<b>%{label}</b><br>N: %{value}<extra></extra>", #formato del tooltip (lo que aparece al posar el mouse sobre un sector)
  textfont        = list(family = "storia-sans, sans-serif"), #fuentes del texto dentro/afuera de la torta
  insidetextfont  = list(family = "storia-sans, sans-serif"), 
  outsidetextfont = list(family = "storia-sans") 
) |> #sintaxis pipe, que nos permite encadenar funciones
  plotly::layout(title = "'¿Qué sustancia consume semanalmente?'", font=list(family="storia-sans"))|>  #título del gráfico y fuente personalizada
  plotly::layout(legend = list(title = list(text = "<b> Categorías </b>")))|> #título de la leyenda. las b negritas (bold) se hacen con html
  layout( #otras opciones de formato
    font=list(family="storia-sans"), # fuente personalizada
    paper_bgcolor = "rgba(0,0,0,0)", plot_bgcolor  = "rgba(0,0,0,0)") # → fondo del lienzo y del área de trazado
```
:::
:::
::: {.notes}
`r invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#")`

:::

## Hacer una imágen dinámica (2)

::: {.fragment}
:::{.xxsmall}
```{r}
#| code-line-numbers: "1-3|4|5|6|7|8|9|10|11|12|13|14|15|16|17"
#| echo: true
#| code-fold: false
#| fig-align: "center"
#| warnings: false
#| message: false
#| fig.showtext: true
#| fig-background: "transparent"
# --- Datos FICTICIOS ---
datos <- tibble::tibble(candidato = c("Kast", "Jara", "Kaiser", "Mathei"), recuento_salud = c(48, 62, 15, 51))
# --- Gráfico de barras ---
highcharter::hchart(datos, #datos
  type = "column", #tipo de gráfico, por barras
  highcharter::hcaes(x = candidato, y = recuento_salud) #definimos las aes: eje x y eje y
) |> #sintaxis pipe, que nos permite encadenar funciones
  highcharter::hc_title(text = "Recuento de la palabra 'salud' en programas (ficticio)") |> #título del gráfico
  highcharter::hc_yAxis(title = list(text = "Número de menciones")) |> #eje y, etiqueta
  highcharter::hc_xAxis(title = list(text = "Candidaturas")) |> #eje x, etiqueta
  highcharter::hc_tooltip(pointFormat = "<b>{point.y}</b> menciones") |> #formato del tooltip (lo que aparece al posar el mouse sobre una barra): número de menciones en negrita (bold)
  highcharter::hc_plotOptions(column = list(# opciones de formato específico para gráfico de barras
      borderWidth = 0, #sin borde
      dataLabels = list(enabled = TRUE))) |># mostrar valor encima de barra
  highcharter::hc_chart(backgroundColor = "rgba(0,0,0,0)") |> #color de fondo trasparente
  highcharter::hc_add_theme(highcharter::hc_theme(chart = list(style = list(fontFamily = "storia-sans")))) |> #definir fuente personalizada
  highcharter::hc_exporting(enabled = TRUE) #habilitar exportación
```
:::
:::
::: {.notes}
`r invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#")`

:::


## Hacer una imágen dinámica (3)

::: {.fragment}
:::{.xxsmall}

```{r}
#| echo: true
#| code-fold: true
#| code-summary: "expandir para código"
#| fig-align: "center"
#| warnings: false
#| message: false
# Datos tipo "tibble" (generados de forma reproducible)
set.seed(123)
fechas <- seq(as.Date("2017-11-01"), as.Date("2023-02-01"), by = "1 month")
n <- length(fechas)

# Series que imitan patrones y rangos de IVE en el período (verde ~40–70; azul ~2–16)
serie_verde <- round(55 + 12*sin(2*pi*(1:n)/12) + 6*rnorm(n)) |> pmax(38) |> pmin(70)
serie_azul  <- round( 9 +  4*sin(2*pi*(1:n)/12 + 1.2) + 3*rnorm(n)) |> pmax(2)  |> pmin(16)

datos <- tibble::tibble(
  mes = fechas,
  verde = serie_verde,
  azul  = serie_azul
) |>
  dplyr::mutate(mes_anio = format(mes, "%b %Y")) |>
  dplyr::select(mes, mes_anio, verde, azul)
```

```{r}
#| code-line-numbers: "1-2|3|4|5-7|8|9|10|11|12"
#| echo: true
#| code-fold: false
#| fig-align: "center"
#| warnings: false
#| message: false
#| fig.showtext: true
#| fig-background: "transparent"
#| fig.cap: "Recuento mensual de interrupciones y continuaciones de embarazo ficticio (azul=continuar)"
p3<- 
ggplot2::ggplot(datos, ggplot2::aes(x = mes)) + #formato wide. cada variable es una columna, en este caso
  geom_line(ggplot2::aes(y = verde, color = "Interrupciones"), size = 1) + #añadimos una capa de línea con las interrupciones
  geom_line(ggplot2::aes(y = azul, color = "Continuaciones"), size = 1) + #añadimos una capa de línea con las continuaciones
  scale_color_manual(#generamos la leyenda
    name = "Leyenda",#título de la leyenda
    values = c("Interrupciones" = "#01c9ad", "Continuaciones" = "#9682fc"))+#colores de las líneas
  labs(y = "Número de casos", x = "Fecha")+ #Definimos las etiquetas de ejes
  theme_minimal(base_family = "storia-sans") #+ #tema minimalista, con la fuente personalizada
ggplotly(p3) |> #convertimos a plotly. ojo que el tooltip se genera por defecto, pero se puede personalizar
  layout(font=list(family="storia-sans"), # fuente personalizada
         paper_bgcolor = "rgba(0,0,0,0)",  plot_bgcolor  = "rgba(0,0,0,0)") # → fondo del lienzo y fondo del área de trazado
```
:::
:::
::: {.notes}
`r invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#")`

:::


## Consideraciones sobre Shiny

- Requiere conocimientos en HTML y CSS para personalizaciones avanzadas.

- Shiny es una aplicación web: pensar en usuarios, inputs, outputs, validaciones, errores.

- Al funcionar como aplicación independiente, es importante considerar recursos de despliegue y alojamiento.

- Para auditar (`logger`) + logs más detallados: `options(shiny.fullstacktrace = TRUE)`

::: {.notes}
`r invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#")`
**PROS**
- Shiny es ideal para crear aplicaciones web interactivas con R.
- Permite a los usuarios interactuar con datos y visualizaciones de manera dinámica.
- Facilita la comunicación de resultados complejos de manera accesible.
- Requiere conocimientos básicos de R y comprensión de la estructura de Shiny.
- Es importante considerar la escalabilidad y el rendimiento al diseñar aplicaciones Shiny.
**CONTRAS**
- Puede tener limitaciones en términos de rendimiento para aplicaciones muy complejas o con grandes volúmenes de datos.
- La personalización avanzada puede requerir conocimientos adicionales de HTML, CSS y JavaScript.
- La implementación y el alojamiento de aplicaciones Shiny pueden implicar costos adicionales.
- **ERRORES COMUNES**. Recordar que es una APLICACION WEB: 
  - No usar `reactive()` para datos que dependen de entradas del usuario.
  - Olvidar llamar a funciones reactivas con paréntesis `()`.
  - No manejar adecuadamente los errores y validaciones de entrada.
  - No optimizar el rendimiento para aplicaciones con grandes conjuntos de datos.
  - Rutas codificadas fijas que fallan en producción.
  - Manipulación de datos ad hoc dentro del servidor (lento e ineficiente).
  - Sin registro formal de dependencias de paquetes.
  - Sin pruebas. Sin registros. Falta de control de cambios (trazabilidad).
- **RECOMENDACIONES**: 
  - Construir teniendo en cuenta la validación.
  - Documentar a medida que se construye.
  - Automatizar lo más posible.
  - Elegir herramientas que añadan transparencia y trazabilidad.
:::


## Aplicaciones más allá del módulo

- ShinyQDA: Aplicación para análisis cualitativo de datos.

- [Shinydashboard](https://tilburgsciencehub.com/topics/visualization/data-visualization/dashboarding/shinydashboard/): Paquete para crear dashboards interactivos con Shiny.

- Flexdashboard: Paquete para crear dashboards flexibles y responsivos.

- R Shiny Gallery: Colección de ejemplos y aplicaciones Shiny.

- shinytest2: Paquete para pruebas automatizadas de aplicaciones Shiny.

- [Asistente Shiny (AI)](https://gallery.shinyapps.io/assistant/): Herramienta para generar código Shiny utilizando inteligencia artificial.


## Nos vemos en clase!

**Si le interesa**:

- Descargue el código fuente desde este este [script](https://raw.githubusercontent.com/AGSCL/shiny_vis/main/_ex/ej_shiny_ggplot.R)

- Genere una aplicación en Shiny

- Explore paso por paso e indique qué se hizo

- Haga esta prueba didáctica de [**reforzamiento**](https://agscl3.shinyapps.io/prueba/)

```{r}
#| out-width: "50%"

#magick::image_read(path = "_figs/piolin_gracias.gif")
```

## Fuentes {.nonincremental}

::: {.xsmall}

- Breuer, J., & Aust, F. (2022, 27-28 de Abril). Reproducible research workflows for psychologists: Other topics in reproducible research [Presentation]. KU Leuven. Obtenido desde: https://frederikaust.com/reproducible-research-practices-workshop/slides/7_Other_Topics.html

- Wembo, J. (2024, 24 de Septiembre). Learn Docker. DataCamp. https://www.datacamp.com/blog/learn-docker

- Plaza-Vega, F. (2024). Mini curso: Quarto y GitHub Pages. III Jornadas de Ingeniería Estadística 202, 11 y 12 de Noviembre 2024, Auditorio DMCC Universidad de Santiago de Chile. https://github.com/FranPlaza/Quarto-Github

- Xie, Y. (2024). Dynamic Documents with R and Quarto (2nd ed.). Chapman and Hall/CRC. https://quarto.org

- The Jumping Rivers Blog. (2025, 30 de junio). Building trust with code: Validating Shiny apps in regulated environments. R-Bloggers. https://www.r-bloggers.com/2025/06/building-trust-with-code-validating-shiny-apps-in-regulated-environments-2/

- Tutorial oficial de Shiny. (s.f.). Shiny from RStudio. Obtenido 04 de Noviembre de 2025, desde https://shiny.posit.co/r/getstarted/

- Galería de ejemplos de Shiny. (s.f.). Shiny from RStudio. Obtenido 04 de Noviembre de 2025, desde https://shiny.posit.co/gallery/

- Wickham, H. (2021). Mastering Shiny [versión en línea]. Recuperado el 3 de noviembre de 2025, de https://mastering-shiny.org/

:::

::: {.notes}
`r invisible("#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#")`
https://agscl.github.io/proc_seleccion/poster.html 
https://agscl.github.io/proc_seleccion/proy_proc_sel.html 
https://github.com/AGSCL/proc_seleccion/blob/main/.github/workflows/main.yml

:::

<!----
#https://quarto.org/docs/presentations/revealjs/presenting.html
---->
